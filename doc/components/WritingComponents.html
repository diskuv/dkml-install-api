<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing Components &mdash; DKML Install API  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Standard Components" href="StandardComponents.html" />
    <link rel="prev" title="Component Authors" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #3347A9" >
            <a href="../../index.html" class="icon icon-home"> DKML Install API
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Getting Started with the DKML Install API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packages/Console.html">Console Packager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Component Authors</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html">Component Authors</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-module">Configuration Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#staging-files">Staging Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#static-files">Static Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="StandardComponents.html">Standard Components</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Design.html">Design</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #3347A9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DKML Install API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Component Authors</a></li>
      <li class="breadcrumb-item active">Writing Components</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/doc/components/WritingComponents.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-components">
<span id="writingcomponents"></span><h1>Writing Components<a class="headerlink" href="#writing-components" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>You first decision will be how to break your installation into one or more
components.</p>
<p>A component is an optional set of logic in the form of bytecode executables,
and an optional set of “staging” files used by the bytecode logic, and an
optional set of “static” files that will be installed as-is on the end-user
machine.</p>
<p>Each “feature” component should deliver a single set of functionality
to the end-user. Your decision is simple: each feature component should
correspond to one “feature” selectable by the end-user at installation time.
If, for example, you are creating an installer for a text editor, then you
could have one feature be the text editor, while you have multiple features for
the multiple language packs your editor supports.</p>
<p>Each “support” component should deliver a single set of functionality that is
shared between components. For example, almost all components will need the
the [ocamlrun] support component so each feature component can run their
bytecode executables.</p>
<p>Every installation uses a <code class="docutils literal notranslate"><span class="pre">dkml-install-runner.exe</span></code> executable customized
to an installer. The component you write will be linked into
<code class="docutils literal notranslate"><span class="pre">dkml-install-runner.exe</span></code> at installation time.</p>
<p>A component has a <a class="reference internal" href="#configurationmodule"><span class="std std-ref">Configuration Module</span></a> that configures values and methods
used in the installation lifecycle and in the installer generators.</p>
<p>For example, when the following configuration values are defined:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Term</span> <span class="o">=</span> <span class="nn">Cmdliner</span><span class="p">.</span><span class="nc">Term</span>

<span class="k">let</span> <span class="n">component_name</span> <span class="o">=</span> <span class="s2">&quot;something&quot;</span>

<span class="k">let</span> <span class="n">execute_install</span> <span class="n">ctx</span> <span class="o">=</span>
    <span class="nn">Format</span><span class="p">.</span><span class="n">printf</span>
      <span class="s2">&quot;Here is where we would install using bytecode run with: %s@</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">path_eval</span> <span class="s2">&quot;%{ocamlrun:share-abi}/bin/ocamlrun&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="n">install_user_subcommand</span> <span class="o">~</span><span class="n">component_name</span> <span class="o">~</span><span class="n">subcommand_name</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;Install a component called &quot;</span> <span class="o">^</span> <span class="n">component_name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span>
        <span class="o">(</span> <span class="nn">Term</span><span class="p">.</span><span class="o">(</span><span class="n">const</span> <span class="n">execute_install</span> <span class="o">$</span> <span class="n">ctx_t</span><span class="o">),</span> <span class="nn">Term</span><span class="p">.</span><span class="n">info</span> <span class="n">subcommand_name</span> <span class="o">~</span><span class="n">doc</span> <span class="o">)</span>
    <span class="k">in</span>
    <span class="nc">Ok</span> <span class="n">cmd</span>
</pre></div>
</div>
<p>the <code class="docutils literal notranslate"><span class="pre">dkml-install-runner.exe</span></code> executable will be generated so that
the following can occur:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dkml-install-runner.exe something
<span class="go">Installing ... okay, it is done!</span>

<span class="gp">$ </span>dkml-install-runner.exe --help
</pre></div>
</div>
<p>A component can also have <a class="reference internal" href="#stagingfiles"><span class="std std-ref">Staging Files</span></a>
that will be available during installation (but not after), and can also have
<a class="reference internal" href="#staticfiles"><span class="std std-ref">Static Files</span></a> that will be installed directly to the final end-user
installation folder.</p>
<p>As a component author you will need to write a <a class="reference internal" href="#configurationmodule"><span class="std std-ref">Configuration Module</span></a>
with methods like <code class="docutils literal notranslate"><span class="pre">install_user_subcommand</span></code> that will <code class="docutils literal notranslate"><span class="pre">execute</span></code> at
installation time.</p>
<dl>
<dt>Copy Scenario</dt><dd><p>You may want to simply copy some files from your component’s build directories
into your end-user’s installation folder without modification.</p>
<p>In your <code class="docutils literal notranslate"><span class="pre">dune</span></code> file you would use:</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">install</span><span class="w"> </span><span class="p">(</span><span class="nv">TODO</span><span class="w"> </span><span class="nv">StaticFiles</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>Your <code class="docutils literal notranslate"><span class="pre">execute</span></code> should do nothing (ex. <code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">execute</span> <span class="pre">()</span> <span class="pre">=</span> <span class="pre">()</span> <span class="pre">in</span></code>).</p>
</dd>
<dt>Transform Scenario</dt><dd><p>You may want to copy <em>and transform</em> files from your component’s build
directories into your end-user’s installation folder. For example, you
may want to replace all <code class="docutils literal notranslate"><span class="pre">&#64;&#64;INSTALL_PLACEHOLDER_EXAMPLE&#64;&#64;</span></code> placeholders
in all files with the end-user installation directory.</p>
<p>In your <code class="docutils literal notranslate"><span class="pre">dune</span></code> files you would copy the original files into staging:</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">install</span><span class="w"> </span><span class="p">(</span><span class="nv">TODO</span><span class="w"> </span><span class="nv">StagingFiles</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>Then in your <code class="docutils literal notranslate"><span class="pre">execute</span></code> you would use the <code class="docutils literal notranslate"><span class="pre">bos</span></code> package to copy
from staging into static with something like the following:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">execute</span> <span class="bp">()</span> <span class="o">=</span> <span class="c">(* TODO copy from staging to static *)</span>
<span class="k">in</span>
</pre></div>
</div>
</dd>
<dt>Compute Scenario</dt><dd><p>You may want to compute or generate files into your end-user’s installation
folder. For example, you may want to compile a native code binary at
installation time and place it in your end-users’ installation folder.</p>
<p>In your <code class="docutils literal notranslate"><span class="pre">dune</span></code> files you would copy the raw materials (if any) into
staging, and generate a bytecode executable that can do the computations.
For compilation the raw materials are the source code you will compile on
the end-user’s machine, and the bytecode executable will invoke the
compiler on the end-user’s machine.</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">executable</span><span class="w"> </span><span class="p">(</span><span class="nv">TODO</span><span class="w"> </span><span class="nv">bytecode</span><span class="p">))</span><span class="w"></span>
<span class="p">(</span><span class="nv">install</span><span class="w"> </span><span class="p">(</span><span class="nv">TODO</span><span class="w"> </span><span class="nv">StagingFiles</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>Then in your <code class="docutils literal notranslate"><span class="pre">execute</span></code> you would use the <code class="docutils literal notranslate"><span class="pre">dkml-component-ocamlrun-api</span></code>
package to invoke your bytecode executable:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">execute</span> <span class="bp">()</span> <span class="o">=</span> <span class="c">(* TODO invoke ocamlrun using api *)</span>
<span class="k">in</span>
</pre></div>
</div>
<p>You would also add a dependency in your <code class="docutils literal notranslate"><span class="pre">.opam</span></code> file to include
<code class="docutils literal notranslate"><span class="pre">dkml-component-ocamlrun</span></code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Most of the heavy work should be done in your bytecode executables.</p>
<p>You may think that you can run OCaml code directly in your configuration
functions like <code class="docutils literal notranslate"><span class="pre">install_user_subcommand</span></code>, but configuration functions
have only limited access to external OCaml libraries. See
<a class="reference internal" href="#configurationmodule"><span class="std std-ref">Configuration Module</span></a> for more details.</p>
</div>
</dd>
</dl>
</section>
<section id="configuration-module">
<span id="configurationmodule"></span><h2>Configuration Module<a class="headerlink" href="#configuration-module" title="Permalink to this heading"></a></h2>
<p>Configuration functions can only access:
* the OCaml Stdlib
* the other conventional OCaml libraries like <code class="docutils literal notranslate"><span class="pre">unix</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">bigarray</span></code>
* the <code class="docutils literal notranslate"><span class="pre">dkml-install-api</span></code> package
* the <code class="docutils literal notranslate"><span class="pre">bos</span></code> (Basic Operating System) package, version <code class="docutils literal notranslate"><span class="pre">0.2.1</span></code></p>
<p>Any call to a library outside of the above list will result in a
<code class="docutils literal notranslate"><span class="pre">Dynlink.Unavailable_unit</span></code> error. Instead just generate a bytecode executable
and place it in the <a class="reference internal" href="#stagingfiles"><span class="std std-ref">Staging Files</span></a>. You will be able to use Dune to
bundle as many libraries as you need into the single bytecode executable file.
You also have no restrictions on what versions of the libraries you bundle.</p>
<p>You can have <a class="reference internal" href="StandardComponents.html#standardcomponents"><span class="std std-ref">Standard Components</span></a> available to you in the USER_INSTALL
phase so you can run any bytecode executables you have placed in
<code class="docutils literal notranslate"><span class="pre">&lt;share&gt;/staging-files/</span></code>, or compile new native executables on the end-users
machine. Just declare a dependency on them using the instructions in their
documentation.</p>
</section>
<section id="staging-files">
<span id="stagingfiles"></span><h2>Staging Files<a class="headerlink" href="#staging-files" title="Permalink to this heading"></a></h2>
<p>As a Component author you should
<strong>only create bytecode executables with no C stubs</strong>
in your OPAM_BUILD phase.</p>
<p>Bytecode executables ensure portability, and not depending on C stubs ensures
that the end-user’s machine does not need specific versions of
specific shared libraries pre-installed.</p>
<p>On Windows and Linux you should build bytecode executables built from a 32-bit
OCaml compiler. 32-bit bytecode works on 64-bit machines, but not all
64-bit bytecode will work on 32-bit machines.</p>
<p>The structure of the staging files directory is:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>staging-files/

    generic/ - Files that will be bundled in all installers

    windows_x86/ - Files that will
        be bundled in all Windows 32-bit installers.

    windows_x86_64/ - Files that will
        be bundled in all Windows 64-bit installers.
</pre></div>
</div>
<p>The goal is simplicity even though it will lead to duplication. For example the
Windows <code class="docutils literal notranslate"><span class="pre">curl.exe</span></code> binary is available from its official download site as a
<code class="docutils literal notranslate"><span class="pre">PE32</span> <span class="pre">executable</span> <span class="pre">(console)</span> <span class="pre">Intel</span> <span class="pre">80386</span> <span class="pre">(stripped</span> <span class="pre">to</span> <span class="pre">external</span> <span class="pre">PDB),</span> <span class="pre">for</span> <span class="pre">MS</span> <span class="pre">Windows</span></code>
executable, as reported by the Unix/MSYS2/Cygwin tool <code class="docutils literal notranslate"><span class="pre">/usr/bin/file</span></code>.
That is, it works on any 32-bit or 64-bit Windows machines. So a copy of the
32-bit <code class="docutils literal notranslate"><span class="pre">curl.exe</span></code> would be in both <code class="docutils literal notranslate"><span class="pre">windows_x86/</span></code> and <code class="docutils literal notranslate"><span class="pre">windows_x86_64/</span></code>.</p>
<p>A common way to populate the Staging Files is to use Opam. Using the same
<code class="docutils literal notranslate"><span class="pre">curl.exe</span></code> example, the following <code class="docutils literal notranslate"><span class="pre">dkml-component-staging-curl.opam</span></code> snippet
demonstrates how <code class="docutils literal notranslate"><span class="pre">curl.exe</span></code> and all its native files (DLLs) can be placed in
the appropriate Staging Files folders:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="n">install</span><span class="o">:</span> <span class="o">[</span>
    <span class="o">[</span><span class="s2">&quot;install&quot;</span> <span class="s2">&quot;-d&quot;</span>
        <span class="s2">&quot;%{_:share}%/staging-files/windows_x86/bin&quot;</span>
        <span class="s2">&quot;%{_:share}%/staging-files/windows_x86_64/bin&quot;</span><span class="o">]</span>
    <span class="o">[</span>
        <span class="s2">&quot;unzip&quot;</span>
        <span class="s2">&quot;-o&quot;</span>
        <span class="s2">&quot;-d&quot;</span>
        <span class="s2">&quot;%{_:share}%/staging-files&quot;</span>
        <span class="s2">&quot;curl-7.81.0_1-win32-mingw.zip&quot;</span>
        <span class="s2">&quot;curl-7.81.0-win32-mingw/bin/curl.exe&quot;</span>
        <span class="s2">&quot;curl-7.81.0-win32-mingw/bin/curl-ca-bundle.crt&quot;</span>
        <span class="s2">&quot;curl-7.81.0-win32-mingw/bin/libcurl.def&quot;</span>
        <span class="s2">&quot;curl-7.81.0-win32-mingw/bin/libcurl.dll&quot;</span>
    <span class="o">]</span>
    <span class="o">[</span>
        <span class="s2">&quot;sh&quot;</span>
        <span class="s2">&quot;-euc&quot;</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        install </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">            &#39;%{_:share}%&#39;/staging-files/curl-7.81.0-win32-mingw/bin/* </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">            &#39;%{_:share}%&#39;/staging-files/windows_x86/bin/</span>
<span class="s2">        install </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">            &#39;%{_:share}%&#39;/staging-files/curl-7.81.0-win32-mingw/bin/* </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">            &#39;%{_:share}%&#39;/staging-files/windows_x86_64/bin/</span>
<span class="s2">        rm -rf &#39;%{_:share}%&#39;/staging-files/curl-7.81.0-win32-mingw</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="o">]</span>
<span class="o">]</span>

<span class="n">extra</span><span class="o">-</span><span class="n">source</span> <span class="s2">&quot;curl-7.81.0_1-win32-mingw.zip&quot;</span> <span class="o">{</span>
    <span class="n">src</span><span class="o">:</span> <span class="s2">&quot;https://curl.se/windows/dl-7.81.0_1/curl-7.81.0_1-win32-mingw.zip&quot;</span>
    <span class="n">checksum</span><span class="o">:</span> <span class="o">[</span>
        <span class="s2">&quot;sha256=4e810ae4d8d1195d0ab06e8be97e5629561497f5de2f9a497867a5b02540b576&quot;</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Since there are no Opam operating system selectors (ex. <code class="docutils literal notranslate"><span class="pre">{os</span> <span class="pre">=</span> <span class="pre">&quot;win32&quot;}</span></code>), the
Windows staging-files/ directories are populated even if the build machine is
not Windows. In fact, using <code class="docutils literal notranslate"><span class="pre">{os</span> <span class="pre">=</span> <span class="pre">&quot;win32&quot;}</span></code> would have been incorrect:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="n">install</span><span class="o">:</span> <span class="o">[</span>
    <span class="o">[</span><span class="s2">&quot;install&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;%{_:share}%/staging-files/windows/bin&quot;</span><span class="o">]</span> <span class="o">{</span><span class="n">os</span> <span class="o">=</span> <span class="s2">&quot;win32&quot;</span><span class="o">}</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The use of a Opam operating system selector like <code class="docutils literal notranslate"><span class="pre">{os</span> <span class="pre">=</span> <span class="pre">&quot;win32&quot;}</span></code> means
that Linux or macOS build machines cannot cross-compile to Windows. Instead,
have your build machines compile into as many architectures as it supports.</p>
</section>
<section id="static-files">
<span id="staticfiles"></span><h2>Static Files<a class="headerlink" href="#static-files" title="Permalink to this heading"></a></h2>
<p>Any static file will go straight into the end-user installation directory.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Component Authors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="StandardComponents.html" class="btn btn-neutral float-right" title="Standard Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Diskuv, Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>