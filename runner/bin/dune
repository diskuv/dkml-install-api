(library
 (public_name dkml-install-runner.user)
 (name user_main)
 (modules user_main)
 (libraries
  dkml-install.register
  dkml-install-runner.sites
  dkml-install-runner
  dune-site
  dune-site.plugins
  cmdliner))

(rule
 (targets admin-link-flags.sexp)
 (deps
  (:discover config/discover.exe))
 (action
  (run %{discover})))

(library
 (public_name dkml-install-runner.admin)
 (name admin_main)
 (modules admin_main)
 ; To view Application Manifest on Windows, or to sign it, make sure
 ; any ".NET Framework <VERSION> SDK" component is installed with the
 ; Visual Studio Installer. That will give you Mage.exe and MageUI.exe.
 ; Confer: https://docs.microsoft.com/en-us/dotnet/framework/tools/mageui-exe-manifest-generation-and-editing-tool-graphical-client
 ; 
 ; To extract the manifest file:
 ;  & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\mt.exe" '-inputresource:Z:\source\dkml-install-api\_build\install\default\bin\dkml-install-admin-runner.exe;#1' -out:admin2.manifest
 (ocamlopt_flags
  ; Uncomment the following to see how link.exe is invoked through flexlink.exe:
  ; -cclib
  ; -v
  (:include admin-link-flags.sexp))
 (libraries
  dkml-install.register
  dkml-install-runner.sites
  dkml-install-runner
  dune-site
  dune-site.plugins
  cmdliner))

; ------------------------------------------------------

; Validate on a machine that has awk that the executables do not have any
; stub libraries except the ones built for ocamlrun.exe.
; (We do not have a mechanism to distribute stublib DLLs!)

(executable
 (name validate_user)
 (modules validate_user)
 (modes (byte exe))
 (libraries dkml-install-runner.user))

(executable
 (name validate_admin)
 (modules validate_admin)
 (modes (byte exe))
 (libraries dkml-install-runner.admin))

(rule
  (alias runtest)
  (target user_main.dlls.txt.corrected)
  (deps (:bc validate_user.bc))
  ; (enabled_if (<> %{os_type} Win32))
  (action
    (progn
      (with-stdout-to %{target}.info (run ocamlobjinfo %{bc}))
      (with-stdout-to %{target} (run awk "/.*:/ {x=0} /Used DLLs:/{x=1} x==1 {print}" %{target}.info))
      (diff user_main.dlls.txt user_main.dlls.txt.corrected))))

(rule
  (alias runtest)
  (target admin_main.dlls.txt.corrected)
  (deps (:bc validate_admin.bc))
  ; (enabled_if (<> %{os_type} Win32))
  (action
    (progn
      (with-stdout-to %{target}.info (run ocamlobjinfo %{bc}))
      (with-stdout-to %{target} (run awk "/.*:/ {x=0} /Used DLLs:/{x=1} x==1 {print}" %{target}.info))
      (diff admin_main.dlls.txt admin_main.dlls.txt.corrected))))
